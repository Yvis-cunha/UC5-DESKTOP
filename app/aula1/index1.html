<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Gastos Pessoais</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Inter e cores de fundo */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Azul Escuro */
            color: #e4e4e7; /* Texto claro */
        }
        /* Estilos espec√≠ficos para o cart√£o de saldo */
        .card-green {
            background-color: #2b2d42; /* Azul quase preto */
            border-left: 5px solid #4CAF50; /* Verde para Receitas */
        }
        .card-red {
            background-color: #2b2d42;
            border-left: 5px solid #F44336; /* Vermelho para Despesas */
        }
        /* Estilos para o bot√£o de deletar */
        .delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .transaction-item:hover .delete-btn {
            opacity: 1;
        }
        /* Estilo para focar nos inputs */
        input:focus, select:focus {
            border-color: #7f5af0 !important;
            box-shadow: 0 0 0 3px rgba(127, 90, 240, 0.5) !important;
        }
    </style>
    <!-- L√≥gica JavaScript para Gerenciamento de Gastos (usando localStorage) -->
    <script type="module">
        // Chave de armazenamento local para persist√™ncia dos dados
        const STORAGE_KEY = 'gastos_pessoais_transactions';
        
        // Elementos do DOM (s√£o buscados antes de qualquer outra opera√ß√£o)
        const balanceDisplay = document.getElementById('balance-display');
        const revenueDisplay = document.getElementById('revenue-display');
        const expenseDisplay = document.getElementById('expense-display');
        const transactionList = document.getElementById('transaction-list');
        const userDisplay = document.getElementById('user-id-display');
        const transactionForm = document.getElementById('transaction-form');
        const loadingIndicator = document.getElementById('loading-indicator');
        const mainContent = document.getElementById('main-content');
        
        // Fun√ß√£o para formatar o valor como moeda brasileira (R$)
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        };
        
        // --- Fun√ß√µes de Storage ---

        /**
         * Carrega transa√ß√µes do localStorage.
         * @returns {Array<Object>} Lista de transa√ß√µes.
         */
        const loadTransactions = () => {
            try {
                const json = localStorage.getItem(STORAGE_KEY);
                // Converte de JSON para Array. Adiciona timestamp se faltar.
                const transactions = json ? JSON.parse(json) : [];
                return transactions.map(t => ({
                    ...t,
                    timestamp: t.timestamp || Date.now()
                }));
            } catch (e) {
                console.error("Erro ao carregar transa√ß√µes do localStorage:", e);
                return [];
            }
        };

        /**
         * Salva transa√ß√µes no localStorage.
         * @param {Array<Object>} transactions - Lista de transa√ß√µes a salvar.
         */
        const saveTransactions = (transactions) => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
            } catch (e) {
                console.error("Erro ao salvar transa√ß√µes no localStorage:", e);
                alertUser("N√£o foi poss√≠vel salvar os dados. O armazenamento local pode estar cheio.");
            }
        };

        /**
         * Carrega transa√ß√µes do storage, ordena e chama a renderiza√ß√£o.
         */
        const loadTransactionsAndRender = () => {
            const transactions = loadTransactions();
            // Ordena por timestamp, do mais recente para o mais antigo.
            transactions.sort((a, b) => b.timestamp - a.timestamp);
            renderTransactions(transactions);

            // Esconde o indicador de carregamento e mostra o conte√∫do principal
            if (mainContent && loadingIndicator) {
                mainContent.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
            } else {
                console.error("Elementos principais n√£o encontrados. O carregamento pode ter falhado.");
            }
        };
        
        // --- Fun√ß√µes de L√≥gica do App ---

        /**
         * Marca a pr√≥xima parcela de uma transa√ß√£o como paga.
         * @param {string} id - O ID da transa√ß√£o parcelada.
         */
        const payInstallment = async (id) => {
            // A chamada para confirmUser usa a vers√£o exposta ao window
            const confirmation = await confirmUser("Confirmar o pagamento da pr√≥xima parcela?");
            if (!confirmation) return;

            let transactions = loadTransactions();
            const index = transactions.findIndex(t => t.id === id);

            if (index !== -1) {
                const t = transactions[index];
                if (t.isInstallment && t.paidInstallments < t.totalInstallments) {
                    // Adiciona a transa√ß√£o como paga, o que impactar√° o saldo total.
                    t.paidInstallments += 1; 
                    saveTransactions(transactions);
                    loadTransactionsAndRender();
                } else if (t.paidInstallments >= t.totalInstallments) {
                    alertUser("Esta conta parcelada j√° foi totalmente paga!");
                }
            }
        };


        /**
         * Deleta uma transa√ß√£o do localStorage.
         * @param {string} id - O ID da transa√ß√£o.
         */
        const deleteTransaction = async (id) => {
            // A chamada para confirmUser usa a vers√£o exposta ao window
            const confirmation = await confirmUser("Tem certeza que deseja deletar esta transa√ß√£o?");
            if (!confirmation) return;
            
            let transactions = loadTransactions();
            // Filtra e mant√©m todas as transa√ß√µes, exceto a com o ID correspondente
            transactions = transactions.filter(t => t.id !== id);
            saveTransactions(transactions);

            loadTransactionsAndRender(); // Recarrega e renderiza
        };


        /**
         * Adiciona uma nova transa√ß√£o ao localStorage.
         * @param {Event} e - O evento de envio do formul√°rio.
         */
        const addTransaction = (e) => {
            e.preventDefault();
            
            const description = document.getElementById('description').value.trim();
            const amount = parseFloat(document.getElementById('amount').value);
            const type = document.getElementById('type').value;
            const isInstallment = document.getElementById('is-installment').checked;
            const totalInstallmentsInput = document.getElementById('total-installments').value;
            
            if (!description || isNaN(amount) || amount <= 0 || !type) {
                alertUser("Por favor, preencha a descri√ß√£o, valor e tipo corretamente.");
                return;
            }

            let newTransaction;

            if (isInstallment) {
                const totalInstallments = parseInt(totalInstallmentsInput, 10);
                
                if (type === 'receita') {
                    alertUser("O parcelamento foi projetado apenas para Despesas (gastos). Use a op√ß√£o Receita normal para entradas.");
                    return;
                }
                if (isNaN(totalInstallments) || totalInstallments < 2) {
                    alertUser("Para parcelar, o 'Total de Parcelas' deve ser um n√∫mero inteiro maior que 1.");
                    return;
                }

                // Armazenamos o valor da parcela individual (negativo para despesa)
                const installmentAmount = amount * -1; 
                
                newTransaction = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9), 
                    description: description,
                    amount: installmentAmount,
                    type: 'despesa', // For√ßado para despesa
                    timestamp: Date.now(), 
                    isInstallment: true,
                    totalInstallments: totalInstallments,
                    paidInstallments: 1, // Come√ßa em 1 (a primeira parcela que est√° sendo registrada/paga)
                };

            } else {
                // L√≥gica de transa√ß√£o padr√£o
                const finalAmount = (type === 'despesa' ? -1 : 1) * amount;
                
                newTransaction = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9), 
                    description: description,
                    amount: finalAmount,
                    type: type,
                    timestamp: Date.now(),
                    isInstallment: false,
                };
            }

            const transactions = loadTransactions();
            transactions.push(newTransaction);
            saveTransactions(transactions);
            
            loadTransactionsAndRender(); 
            transactionForm.reset();
            // Reseta a interface de parcelamento
            document.getElementById('is-installment').checked = false;
            document.getElementById('installment-fields').classList.add('hidden');
        };

        /**
         * Renderiza a lista de transa√ß√µes e atualiza os totais.
         * @param {Array<Object>} transactions - Lista de transa√ß√µes do localStorage.
         */
        const renderTransactions = (transactions) => {
            let totalRevenue = 0;
            let totalExpense = 0;
            
            transactionList.innerHTML = ''; // Limpa a lista
            
            if (transactions.length === 0) {
                transactionList.innerHTML = `<p class="text-center text-gray-400 py-4">Nenhuma transa√ß√£o registrada ainda.</p>`;
            }

            transactions.forEach(t => {
                let amount = Math.abs(t.amount);
                
                // O saldo total √© a soma dos valores de todas as transa√ß√µes (Receitas e Despesas/Parcelas).
                if (t.amount < 0) {
                    totalExpense += amount;
                } else {
                    totalRevenue += amount;
                }
                
                const sign = t.amount < 0 ? '-' : '+';
                const colorClass = t.amount < 0 ? 'text-red-400' : 'text-green-400';
                
                // --- Conte√∫do Customizado para Parcelas ---
                let descriptionHTML = `<p class="font-semibold text-white">${t.description}</p>`;
                let actionButtonHTML = '';

                if (t.isInstallment) {
                    const remaining = t.totalInstallments - t.paidInstallments;
                    const isCompleted = remaining <= 0;
                    const statusColor = isCompleted ? 'text-green-400' : 'text-yellow-400';
                    const statusText = isCompleted ? 'TOTALMENTE PAGA' : `${t.paidInstallments}/${t.totalInstallments}`;

                    descriptionHTML += `
                        <p class="text-xs ${statusColor} font-medium mt-1">
                            Parcelas Pagas: ${statusText} | Restantes: ${remaining > 0 ? remaining : 0}
                        </p>
                    `;
                    
                    if (!isCompleted) {
                        // Importante: Chama window.payInstallment
                        actionButtonHTML = `
                            <button 
                                class="text-indigo-200 hover:text-white font-bold text-xs py-2 px-3 rounded-xl bg-indigo-700 hover:bg-indigo-600 transition duration-200 shadow-md"
                                onclick="window.payInstallment('${t.id}')"
                                title="Marcar a pr√≥xima parcela como paga"
                            >
                                Pagar Pr√≥xima
                            </button>
                        `;
                    }
                }
                
                const dateString = new Date(t.timestamp).toLocaleDateString('pt-BR');

                // Cria o elemento da transa√ß√£o
                const item = document.createElement('div');
                item.className = `transaction-item flex justify-between items-center p-4 rounded-xl mb-2 transition duration-150 ease-in-out ${t.amount < 0 ? 'bg-red-900/10 hover:bg-red-900/20' : 'bg-green-900/10 hover:bg-green-900/20'}`;
                item.innerHTML = `
                    <div class="flex-1 min-w-0">
                        ${descriptionHTML}
                        <p class="text-xs text-gray-400">${dateString}</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        ${actionButtonHTML}
                        <p class="font-bold text-lg ${colorClass} w-24 text-right">
                            ${sign} ${formatCurrency(amount)}
                        </p>
                        <button 
                            class="delete-btn text-red-500 hover:text-red-400 p-1 rounded-full"
                            onclick="window.deleteTransaction('${t.id}')"
                            title="Deletar Transa√ß√£o (Deleta todas as parcelas)"
                        >
                            <!-- √çcone de Lixeira (SVG inline) -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 100 2v6a1 1 0 100-2V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                transactionList.appendChild(item);
            });

            // Atualiza o resumo
            const netBalance = totalRevenue - totalExpense;
            if (balanceDisplay) balanceDisplay.textContent = formatCurrency(netBalance);
            
            // Altera a borda do saldo total
            if (balanceDisplay && balanceDisplay.parentElement) {
                balanceDisplay.parentElement.classList.remove('border-green-500', 'border-red-500', 'border-indigo-500');
                balanceDisplay.parentElement.classList.add(netBalance >= 0 ? 'border-green-500' : 'border-red-500');
                balanceDisplay.parentElement.classList.add('border-l-4');
            }


            if (revenueDisplay) revenueDisplay.textContent = formatCurrency(totalRevenue);
            if (expenseDisplay) expenseDisplay.textContent = formatCurrency(totalExpense);
        };

        // --- Fun√ß√µes Modais Customizadas (para substituir alert/confirm) ---

        /**
         * Exibe um modal personalizado em vez de alert().
         */
        const alertUser = (message) => {
            const modal = document.getElementById('custom-alert-modal');
            if (modal) {
                document.getElementById('custom-alert-message').textContent = message;
                modal.classList.remove('hidden');
            }
        };

        /**
         * Exibe um modal de confirma√ß√£o personalizado em vez de confirm().
         * @param {string} message - A mensagem de confirma√ß√£o.
         * @returns {Promise<boolean>} - Resolve para true se confirmado, false caso contr√°rio.
         */
        const confirmUser = (message) => {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-confirm-modal');
                if (!modal) {
                    console.error("Modal de confirma√ß√£o n√£o encontrado.");
                    return resolve(false);
                }

                document.getElementById('custom-confirm-message').textContent = message;
                
                const onConfirm = () => {
                    modal.classList.add('hidden');
                    resolve(true);
                    document.getElementById('confirm-yes').removeEventListener('click', onConfirm);
                    document.getElementById('confirm-no').removeEventListener('click', onReject);
                };
                
                const onReject = () => {
                    modal.classList.add('hidden');
                    resolve(false);
                    document.getElementById('confirm-yes').removeEventListener('click', onConfirm);
                    document.getElementById('confirm-no').removeEventListener('click', onReject);
                };

                document.getElementById('confirm-yes').addEventListener('click', onConfirm);
                document.getElementById('confirm-no').addEventListener('click', onReject);
                
                modal.classList.remove('hidden');
            });
        };

        // Exp√µe fun√ß√µes globais para que possam ser chamadas pelos atributos 'onclick' do HTML
        window.deleteTransaction = deleteTransaction;
        window.addTransaction = addTransaction;
        window.alertUser = alertUser;
        window.confirmUser = confirmUser;
        window.payInstallment = payInstallment;

        // Inicia o carregamento dos dados imediatamente ap√≥s o script ser lido
        loadTransactionsAndRender();
    </script>
</head>
<body>

    <!-- Modal de Alerta Customizado (Substitui alert()) -->
    <div id="custom-alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Aviso</h3>
            <p id="custom-alert-message" class="text-gray-700 mb-6"></p>
            <button 
                onclick="document.getElementById('custom-alert-modal').classList.add('hidden')"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
            >
                Entendi
            </button>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o Customizado (Substitui confirm()) -->
    <div id="custom-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Confirma√ß√£o</h3>
            <p id="custom-confirm-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button 
                    id="confirm-no"
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200"
                >
                    N√£o
                </button>
                <button 
                    id="confirm-yes"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
                >
                    Sim, Deletar
                </button>
            </div>
        </div>
    </div>


    <div class="min-h-screen p-4 sm:p-8 max-w-4xl mx-auto">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-white mb-2">üí∞ Meu Gestor de Gastos</h1>
            <p class="text-gray-400" id="user-id-display">Dados salvos localmente no seu navegador.</p>
        </header>

        <!-- Indicador de Carregamento (ser√° ocultado instantaneamente pelo script) -->
        <div id="loading-indicator" class="flex justify-center items-center h-64">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-500"></div>
            <p class="ml-4 text-indigo-400">Carregando dados locais...</p>
        </div>

        <!-- Conte√∫do Principal (Inicialmente escondido) -->
        <div id="main-content" class="hidden">
            
            <!-- Resumo Financeiro -->
            <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                
                <!-- Saldo Total -->
                <div class="bg-[#2b2d42] p-5 rounded-xl shadow-lg border-l-4 border-indigo-500">
                    <p class="text-sm font-medium text-gray-400">Saldo Total</p>
                    <p id="balance-display" class="text-3xl font-bold mt-1 text-white">R$ 0,00</p>
                </div>
                
                <!-- Total de Receitas -->
                <div class="bg-[#2b2d42] p-5 rounded-xl shadow-lg border-l-4 border-green-500">
                    <p class="text-sm font-medium text-gray-400">Total de Receitas</p>
                    <p id="revenue-display" class="text-3xl font-bold mt-1 text-green-400">R$ 0,00</p>
                </div>

                <!-- Total de Despesas -->
                <div class="bg-[#2b2d42] p-5 rounded-xl shadow-lg border-l-4 border-red-500">
                    <p class="text-sm font-medium text-gray-400">Total de Despesas</p>
                    <p id="expense-display" class="text-3xl font-bold mt-1 text-red-400">R$ 0,00</p>
                </div>
            </section>

            <!-- Formul√°rio para Nova Transa√ß√£o -->
            <section class="mb-10 bg-[#1f213a] p-6 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">Adicionar Nova Transa√ß√£o</h2>
                
                <form id="transaction-form" onsubmit="window.addTransaction(event)" class="space-y-4">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        
                        <!-- Campo Descri√ß√£o -->
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-300 mb-1">Descri√ß√£o</label>
                            <input type="text" id="description" placeholder="Ex: Conta de Luz, Sal√°rio" required
                                class="w-full px-4 py-2 rounded-lg bg-[#2b2d42] border border-gray-600 text-white placeholder-gray-500 transition duration-150"
                            >
                        </div>
                        
                        <!-- Campo Valor (Valor da Parcela, se aplic√°vel) -->
                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-300 mb-1">Valor (R$)</label>
                            <input type="number" id="amount" step="0.01" min="0.01" placeholder="100.00 (Valor da Parcela)" required
                                class="w-full px-4 py-2 rounded-lg bg-[#2b2d42] border border-gray-600 text-white placeholder-gray-500 transition duration-150"
                            >
                        </div>
                    </div>
                    
                    <!-- Campo Tipo -->
                    <div>
                        <label for="type" class="block text-sm font-medium text-gray-300 mb-1">Tipo</label>
                        <select id="type" required
                            class="w-full px-4 py-2 rounded-lg bg-[#2b2d42] border border-gray-600 text-white transition duration-150 appearance-none"
                        >
                            <option value="" disabled selected>Selecione o Tipo</option>
                            <option value="receita" class="bg-[#2b2d42] text-green-400">Receita (Entrada)</option>
                            <option value="despesa" class="bg-[#2b2d42] text-red-400">Despesa (Sa√≠da)</option>
                        </select>
                    </div>

                    <!-- Op√ß√£o de Parcelamento -->
                    <div class="p-4 bg-[#2b2d42] rounded-xl border border-gray-600">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="is-installment" class="form-checkbox h-4 w-4 text-indigo-500 bg-gray-700 border-gray-600 rounded" onchange="document.getElementById('installment-fields').classList.toggle('hidden')">
                            <span class="text-sm font-medium text-white">√â uma conta parcelada (Despesa)?</span>
                        </label>
                        
                        <div id="installment-fields" class="hidden mt-3">
                            <label for="total-installments" class="block text-sm font-medium text-gray-300 mb-1">Total de Parcelas</label>
                            <input type="number" id="total-installments" min="2" value="2"
                                class="w-full px-4 py-2 rounded-lg bg-[#1a1a2e] border border-gray-600 text-white transition duration-150"
                                placeholder="Ex: 12"
                            >
                        </div>
                    </div>

                    <!-- Bot√£o de Envio -->
                    <button type="submit"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-[1.01]"
                    >
                        Adicionar Transa√ß√£o
                    </button>
                </form>
            </section>
            
            <!-- Lista de Transa√ß√µes -->
            <section>
                <h2 class="text-2xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">Hist√≥rico de Transa√ß√µes</h2>
                <div id="transaction-list" class="space-y-3">
                    <!-- Transa√ß√µes ser√£o inseridas aqui pelo JavaScript -->
                    <p class="text-center text-gray-400 py-4">Carregando transa√ß√µes...</p>
                </div>
            </section>
        </div>
    </div>

</body>
</html>
